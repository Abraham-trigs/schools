generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MODERATOR
  PRINCIPAL
  VICE_PRINCIPAL
  TEACHER
  ASSISTANT_TEACHER
  COUNSELOR
  LIBRARIAN
  EXAM_OFFICER
  FINANCE
  HR
  RECEPTIONIST
  IT_SUPPORT
  TRANSPORT
  NURSE
  COOK
  CLEANER
  SECURITY
  MAINTENANCE
  STUDENT
  CLASS_REP
  PARENT
  ALUMNI
  AUDITOR
}

model School {
  id        String   @id @default(cuid())
  name      String   @unique
  domain    String   @unique // default domain for generating emails
  email     String   @unique // school's main contact email
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  classes    Class[]
  buses      Bus[]
  finances   Finance[]
  activities Activity[]
  resources  Resource[]
  Book       Book[]
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student      Student?
  staff        Staff?
  libraryStaff LibraryStaff?

  createdSubjects Subject[]

  @@map("users")
}

model Student {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id])
  classId    String?
  class      Class?   @relation(fields: [classId], references: [id])
  enrolledAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  exams        Exam[]
  parents      Parent[]
  transactions Transaction[]
  purchases    Purchase[]
  attendances  StudentAttendance[]
  borrows      Borrow[]

  subjects Subject[] @relation("StudentSubjects") // many-to-many with Subject

  @@map("students")
}

// prisma/schema.prisma
// Purpose: Class model with fully mirrored relations to Students, Staff, Exams, and Subjects

model Class {
  id       String @id @default(cuid())
  name     String
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  students Student[]
  staff    Staff[]
  exams    Exam[]
  subjects Subject[] @relation("ClassSubjects") // many-to-many with Subject

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, schoolId])
  @@map("classes")
}

// prisma/schema.prisma
// Purpose: Subject model with fully aligned relations to Users, Students, Staff, Exams, and Classes

model Subject {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  exams    Exam[]
  staff    Staff[]   @relation("StaffSubjects")
  students Student[] @relation("StudentSubjects") // many-to-many with Student
  classes  Class[]   @relation("ClassSubjects") // many-to-many with Class

  @@map("subjects")
}

// prisma/schema.prisma
// Purpose: Exam model linking Students, Classes, and Subjects with full relational integrity

model Exam {
  id        String   @id @default(cuid())
  studentId String?
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classId   String?
  class     Class?   @relation(fields: [classId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])

  score     Float?
  maxScore  Float?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exams")
}

// prisma/schema.prisma
// Purpose: Staff model linking Users, Classes, Departments, Subjects, and Attendances

model Staff {
  id           String      @id @default(cuid())
  userId       String      @unique
  user         User        @relation(fields: [userId], references: [id])
  classId      String?
  class        Class?      @relation(fields: [classId], references: [id])
  position     String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  salary       Float?
  hireDate     DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  subjects    Subject[]         @relation("StaffSubjects") // many-to-many optional
  attendances StaffAttendance[]

  @@map("staff")
}

// prisma/schema.prisma
// Purpose: Department model linking Staff and LibraryStaff

model Department {
  id           String         @id @default(cuid())
  name         String         @unique
  staff        Staff[]
  libraryStaff LibraryStaff[]

  @@map("departments")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// prisma/schema.prisma
// Purpose: Track student attendance with status, timestamps, and optional remarks

model StudentAttendance {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  date      DateTime         @default(now())
  status    AttendanceStatus
  timeIn    DateTime?
  timeOut   DateTime?
  remarks   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([studentId, date], name: "studentId_date")
  @@map("student_attendances")
}

// prisma/schema.prisma
// Purpose: Track staff attendance with status, timestamps, and optional remarks

model StaffAttendance {
  id        String           @id @default(cuid())
  staffId   String
  staff     Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date      DateTime         @default(now())
  status    AttendanceStatus
  timeIn    DateTime?
  timeOut   DateTime?
  remarks   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@map("staff_attendances")
}

// prisma/schema.prisma
// Purpose: Track parents/guardians linked to students with contact information

model Parent {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  name      String
  email     String   @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parents")
}

// prisma/library.prisma
// Library management models integrated with Department and School

model Author {
  id        String   @id @default(cuid())
  name      String
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("authors")
}

// prisma/schema.prisma
// Purpose: Book model linking to Author, Category, School, and tracking borrows

model Book {
  id          String    @id @default(cuid())
  title       String
  isbn        String    @unique
  authorId    String
  author      Author    @relation(fields: [authorId], references: [id])
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  totalCopies Int       @default(1)
  available   Int       @default(1)
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  borrows Borrow[]

  @@map("books")
}

model Category {
  id        String   @id @default(cuid())
  name      String
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

// prisma/schema.prisma
// Purpose: Track book borrowings by students with due dates, returns, and fines

model Borrow {
  id         String    @id @default(cuid())
  bookId     String
  book       Book      @relation(fields: [bookId], references: [id])
  studentId  String
  student    Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  borrowedAt DateTime  @default(now())
  dueAt      DateTime
  returnedAt DateTime?
  fine       Float     @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([bookId, studentId, borrowedAt], name: "unique_borrow")
  @@map("borrows")
}

// prisma/schema.prisma
// Purpose: LibraryStaff model linking Users to Departments with optional position and hire date

model LibraryStaff {
  id           String     @id @default(cuid())
  userId       String     @unique
  user         User       @relation(fields: [userId], references: [id])
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  position     String?
  hireDate     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("library_staff")
}

//TRANSACTION

enum FinanceType {
  INCOME
  EXPENSE
}

enum FeeType {
  TUITION
  EXAM
  LAB
  SPORTS
  LIBRARY
  TRANSPORT
  UNIFORM
  OTHER
}

//FINANCE 

// prisma/schema.prisma
// Purpose: Track student financial transactions with type, optional fee type, and description

model Transaction {
  id          String      @id @default(cuid())
  studentId   String
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type        FinanceType @default(INCOME)
  feeType     FeeType?
  amount      Float
  date        DateTime    @default(now())
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("transactions")
}

// prisma/schema.prisma
// Purpose: Finance model tracking school income/expenses with full relation to School

model Finance {
  id          String      @id @default(cuid())
  schoolId    String
  school      School      @relation(fields: [schoolId], references: [id])
  type        FinanceType @default(INCOME)
  amount      Float
  description String?
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("finances")
}

// prisma/schema.prisma
// Purpose: Resource model representing school materials with purchases tracking

model Resource {
  id        String   @id @default(cuid())
  name      String
  category  String?
  unitPrice Float
  quantity  Int      @default(1)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]

  @@unique([name, schoolId])
  @@map("resources")
}

// prisma/schema.prisma
// Purpose: Purchase model linking students to acquired resources with cost tracking

model Purchase {
  id         String   @id @default(cuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  quantity   Int      @default(1)
  totalCost  Float
  date       DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("purchases")
}

//SCHOOL SCOPE

// prisma/schema.prisma
// Purpose: Activity model representing school events or tasks linked to a School

model Activity {
  id          String   @id @default(cuid())
  title       String
  description String?
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("activities")
}

// prisma/schema.prisma
// Purpose: Bus model representing school transportation with driver and capacity tracking

model Bus {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  plateNumber String   @unique
  driverName  String
  capacity    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("buses")
}
